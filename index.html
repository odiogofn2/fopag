<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle Interativo de Carteiras</title>

  <!-- Supabase via ES Module -->
  <script type="module">
    import { createClient } from "https://unpkg.com/@supabase/supabase-js@2/dist/supabase-js.esm.js";

    const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.supabase = supabase;
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 95%;
      max-width: 900px;
      margin: 10px auto;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }

    h2 { text-align: center; }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px;
      background: #ddd;
      cursor: pointer;
      border-radius: 8px;
    }

    .tab.ativa { background: #bbb; }

    .painel { display: none; }
    .painel.ativo { display: block; }

    label {
      display: block;
      margin-top: 6px;
      font-size: 14px;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 6px;
      margin-top: 3px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .card {
      background: #eee;
      padding: 8px;
      border-radius: 10px;
      margin-top: 5px;
    }

    table {
      width: 100%;
      margin-top: 6px;
      font-size: 13px;
    }

    .small {
      width: auto;
      display: inline-block;
    }
  </style>
</head>

<body>
<div class="container">
  <h2>Fopag – Gestão de Carteiras</h2>

  <div class="tabs">
    <div class="tab ativa" onclick="abrirTab('cad-pessoas')">Pessoas</div>
    <div class="tab" onclick="abrirTab('cad-carteiras')">Carteiras</div>
    <div class="tab" onclick="abrirTab('cad-mov')">Movimentações</div>
    <div class="tab" onclick="abrirTab('resumo')">Resumo</div>
  </div>

  <!-- ===== PAINEL PESSOAS ===== -->
  <div id="cad-pessoas" class="painel ativo">
    <h3>Cadastro de Pessoas</h3>

    <label>Nome da Pessoa</label>
    <input id="p-nome" placeholder="Maria" />

    <label>Tipo</label>
    <select id="p-tipo">
      <option value="amigo">Amigo</option>
      <option value="familia">Família</option>
    </select>

    <button onclick="criarPessoa()">Salvar Pessoa</button>

    <div id="lista-pessoas"></div>
  </div>

  <!-- ===== PAINEL CARTEIRAS ===== -->
  <div id="cad-carteiras" class="painel">
    <h3>Cadastro de Carteiras</h3>

    <label>Nome da Carteira</label>
    <input id="c-nome" />

    <div class="row">
      <div>
        <label>Saldo Inicial</label>
        <input id="c-saldo" type="number" />
      </div>

      <div>
        <label>Tipo</label>
        <select id="c-tipo">
          <option value="pessoal">Pessoal</option>
          <option value="casa">Casa</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Limite PIX</label>
        <input id="c-limite-pix" type="number" />
      </div>

      <div>
        <label>Limite Dinheiro</label>
        <input id="c-limite-dinheiro" type="number" />
      </div>
    </div>

    <label>Limite Cartão</label>
    <input id="c-limite-cartao" type="number" />

    <button onclick="criarCarteira()">Salvar Carteira</button>

    <div id="lista-carteiras"></div>
  </div>

  <!-- ===== PAINEL MOVIMENTAÇÕES ===== -->
  <div id="cad-mov" class="painel">
    <h3>Nova Movimentação</h3>

    <label>Carteira</label>
    <select id="m-carteira"></select>

    <label>Data</label>
    <input id="m-data" type="datetime-local" class="small" />

    <label>Onde</label>
    <input id="m-onde" />

    <label>Descrição</label>
    <textarea id="m-descricao"></textarea>

    <label>Valor</label>
    <input id="m-valor" type="number" />

    <label>Modo de Pagamento</label>
    <select id="m-modo">
      <option value="pix">PIX</option>
      <option value="dinheiro">Dinheiro</option>
      <option value="cartao">Cartão</option>
    </select>

    <div class="row">
      <div>
        <label>À vista?</label>
        <select id="m-avista">
          <option value="true">Sim</option>
          <option value="false">Não</option>
        </select>
      </div>

      <div>
        <label>Parcelado?</label>
        <select id="m-parcelado">
          <option value="false">Não</option>
          <option value="true">Sim</option>
        </select>
      </div>
    </div>

    <label>Qtd Parcelas / Qtd Pessoas Divisão</label>
    <input id="m-parcelas" type="number" value="2" />

    <label>Dividir com alguém?</label>
    <select id="m-dividido">
      <option value="false">Não</option>
      <option value="true">Sim</option>
    </select>

    <label>Outra Pessoa</label>
    <select id="m-pessoa">
      <option value="">Nenhuma</option>
    </select>

    <label>Observação</label>
    <input id="m-obs" />

    <button onclick="incluirMov()">Salvar Movimentação</button>

    <div id="lista-mov"></div>
  </div>

  <!-- ===== PAINEL RESUMO ===== -->
  <div id="resumo" class="painel">
    <h3>Resumo por Carteira</h3>
    <div id="res-carteiras"></div>
  </div>
</div>

<script>
function abrirTab(id) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('ativa'));
  document.querySelectorAll('.painel').forEach(p=>p.classList.remove('ativo','ativa','ativo','ativo'));

  event.target.classList.add('ativa');
  document.getElementById(id).classList.add('ativo');
}

async function carregarPessoas() {
  const { data } = await window.supabase.from("pessoas").select("*");

  const el = document.getElementById("lista-pessoas");
  const sel = document.getElementById("m-pessoa");

  el.innerHTML = "";
  sel.innerHTML = "<option value=''>Nenhuma</option>";

  (data||[]).forEach(p=>{
    el.innerHTML += `<div class='card'>${p.nome} – ${p.tipo}</div>`;
    sel.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
}

async function criarPessoa() {
  await window.supabase.from("pessoas").insert({
    nome: document.getElementById("p-nome").value,
    tipo: document.getElementById("p-tipo").value
  });

  carregarPessoas();
}

async function carregarCarteiras() {
  const { data } = await window.supabase.from("carteiras").select("*");

  const el = document.getElementById("lista-carteiras");
  const sel = document.getElementById("m-carteira");
  el.innerHTML = "";
  sel.innerHTML = "";

  (data||[]).forEach(c=>{
    el.innerHTML += `<div class='card'>${c.nome} – Saldo: ${c.saldo}</div>`;
    sel.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
  });

  resumoCarteiras();
}

async function criarCarteira() {
  await window.supabase.from("carteiras").insert({
    nome: document.getElementById("c-nome").value,
    saldo: document.getElementById("c-saldo").value,
    tipo: document.getElementById("c-tipo").value,
    limite_pix: document.getElementById("c-limite-pix").value,
    limite_dinheiro: document.getElementById("c-limite-dinheiro").value,
    limite_cartao: document.getElementById("c-limite-cartao").value
  });

  carregarCarteiras();
}

async function incluirMov() {
  const qtd = Number(document.getElementById("m-parcelas").value);

  await window.supabase.from("movimentacoes").insert({
    data: new Date().toISOString(),
    onde: document.getElementById("m-onde").value,
    descricao: document.getElementById("m-descricao").value,
    valor: document.getElementById("m-valor").value,
    carteira_id: document.getElementById("m-carteira").value,
    modo_pagamento: document.getElementById("m-modo").value,
    a_vista: document.getElementById("m-avista").value==="true",
    parcelado: document.getElementById("m-parcelado").value==="true",
    parcelas: qtd,
    outra_pessoa_id: document.getElementById("m-pessoa").value||null,
    dividido: document.getElementById("m-dividido").value==="true",
    observacao: document.getElementById("m-obs").value
  });

  carregarMov();
  resumoCarteiras();
}

async function carregarMov() {
  const { data } = await window.supabase
    .from("movimentacoes")
    .select("*, pessoas(nome), carteiras(nome)")
    .order("data", { desc:true });

  const el = document.getElementById("lista-mov");
  el.innerHTML="";

  (data||[]).forEach(m=>{
    const perc = m.dividido ? (100/qtdValida(m.parcelas)) : 100;

    el.innerHTML += `
      <div class='card'>
        ${m.carteiras?.nome||m.carteira_id}<br/>
        Valor: ${m.valor}<br/>
        Divisão: ${perc}%<br/>
        ${m.pessoas?.nome||""}
      </div>`;
  });
}

function qtdValida(v){ return v>0?v:1; }

async function resumoCarteiras() {
  const { data } = await window.supabase.from("carteiras").select("*");
  const { data: mov } = await window.supabase.from("movimentacoes").select("*");

  const el = document.getElementById("res-carteiras");
  el.innerHTML="";

  (data||[]).forEach(c=>{
    const itens = (mov||[]).filter(m=>m.carteira_id===c.id);

    const totalDiv = itens
      .filter(i=>i.dividido)
      .reduce((a,b)=>a+Number(b.valor),0);

    el.innerHTML += `
      <div class='card'>
        <b>${c.nome}</b><br/>
        Saldo Base: ${c.saldo}<br/>
        Total Dividido: ${totalDiv}
      </div>`;
  });
}

carregarPessoas();
carregarCarteiras();
carregarMov();
</script>
</body>
</html>
