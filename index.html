<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Financeiro</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
 --bg:#f1f3f6;
 --white:#ffffff;
 --border:#e3e7ed;
 --text:#2c3e50;
 --muted:#7f8c8d;
 --primary:#0099ff;
}

*{ box-sizing:border-box }

body{
 margin:0;
 font-family:'Segoe UI', Arial;
 background:var(--bg);
 color:var(--text)
}

.container{
 width:92%;
 max-width:1100px;
 margin:15px auto
}

header{
 font-size:22px;
 font-weight:700;
 margin:10px 0
}

/* ABAS */
.tabs{
 display:flex;
 gap:6px;
 flex-wrap:wrap
}

.tab{
 padding:9px 13px;
 background:#e9ecf0;
 cursor:pointer;
 border-radius:12px 12px 0 0;
 font-size:14px;
 transition:.2s
}

.tab.active{
 background:var(--white);
 border:1px solid var(--border);
 border-bottom:none;
 font-weight:bold
}

.tabcontent{
 display:none;
 background:var(--white);
 padding:14px;
 border-radius:0 14px 14px 14px;
 border:1px solid var(--border);
 box-shadow:0 3px 10px rgba(0,0,0,.07);
 margin-bottom:10px
}

.tabcontent.active{
 display:block
}

/* CARDS */
.card{
 background:var(--white);
 padding:12px;
 margin:8px 0;
 border-radius:16px;
 border:1px solid var(--border);
 box-shadow:0 2px 8px rgba(0,0,0,.05)
}

.row{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:10px
}

.filtros{
 display:grid;
 grid-template-columns:1fr 1fr 1fr;
 gap:8px
}

label{
 font-size:13px;
 font-weight:600;
 display:block;
 margin:4px 2px
}

input,select{
 width:100%;
 padding:9px;
 border:1px solid var(--border);
 border-radius:12px;
 margin-bottom:8px
}

button{
 background:var(--primary);
 color:#fff;
 padding:9px;
 border:none;
 border-radius:12px;
 cursor:pointer;
 font-weight:bold;
 width:100%;
 transition:.2s
}

button:hover{
 opacity:.9
}

.btn-outline{
 background:var(--white);
 border:1px solid var(--primary);
 color:var(--primary)
}

table{
 width:100%;
 border-collapse:collapse;
 margin-top:8px
}

th{
 background:#fafafa;
 text-align:left
}

th,td{
 border:1px solid var(--border);
 padding:8px;
 font-size:13px
}

/* RESUMOS */
.resumos{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:10px
}

.deve{
 border-left:4px solid var(--primary)
}
</style>
</head>

<body>
<div class="container">

<header>üí∞ Controle das Minhas Finan√ßas</header>

<div class="tabs">
 <div class="tab active" onclick="abrirTab(0)">Carteiras</div>
 <div class="tab" onclick="abrirTab(1)">Pessoas</div>
 <div class="tab" onclick="abrirTab(2)">Movimenta√ß√£o</div>
 <div class="tab" onclick="abrirTab(3)">Criar</div>
 <div class="tab" onclick="abrirTab(4)">D√≠vidas</div>
 <div class="tab" onclick="abrirTab(5)">Relat√≥rios</div>
</div>

<!-- CARTEIRAS -->
<div class="tabcontent active">
 <h3>Minhas Carteiras</h3>
 <div id="listaCarteiras"></div>
</div>

<!-- PESSOAS -->
<div class="tabcontent">
 <h3>Pessoas</h3>

 <div class="card">
  <label>Nome</label>
  <input id="nomePessoa" placeholder="Maria, Jo√£o...">

  <label>Tipo</label>
  <select id="tipoPessoa">
   <option value="amigo">Amigo</option>
   <option value="familia">Fam√≠lia</option>
   <option value="cliente">Cliente</option>
   <option value="trabalho">Trabalho</option>
  </select>

  <button onclick="criarPessoa()">Cadastrar</button>
 </div>

 <div id="listaPessoas"></div>
</div>

<!-- MOVIMENTA√á√ÉO -->
<div class="tabcontent">
<h3>Incluir Movimenta√ß√£o</h3>

<div class="card">

<label>Data</label>
<input id="dataMov" type="datetime-local">

<label>Onde</label>
<input id="ondeMov" placeholder="Supermercado">

<label>Descri√ß√£o</label>
<input id="descMov" placeholder="Compra de p√£o">

<label>Valor</label>
<input id="valorMov" type="number">

<label>Carteira</label>
<select id="carteiraMov"></select>

<label>Pagamento</label>
<select id="modoPag">
 <option value="pix">PIX</option>
 <option value="cartao">Cart√£o</option>
 <option value="dinheiro">Dinheiro</option>
 <option value="transferencia">Transfer√™ncia</option>
</select>

<div class="row">
 <div>
  <label>√â √† vista?</label>
  <select id="avista">
   <option value="sim">Sim</option>
   <option value="nao">N√£o</option>
  </select>
 </div>

 <div>
  <label>Parcelas</label>
  <input id="parcelas" type="number" value="1">
 </div>
</div>

<label>Dividido com algu√©m?</label>
<select id="dividido">
 <option value="nao">N√£o</option>
 <option value="sim">Sim</option>
</select>

<label>Outra pessoa envolvida</label>
<select id="outraPessoa"></select>

<label>Observa√ß√£o</label>
<input id="obsMov">

<button onclick="incluirMov()">Registrar</button>

</div>
</div>

<!-- CRIAR -->
<div class="tabcontent">
<h3>Criar Carteira</h3>

<div class="card">
<label>Nome</label>
<input id="nomeCarteira">

<label>Saldo inicial</label>
<input id="saldoCarteira" type="number">

<label>Tipo</label>
<select id="tipoCarteira">
 <option value="conta">Conta Banco do Brasil</option>
 <option value="conta_caixa">Conta Caixa</option>
 <option value="banca">Bet365</option>
 <option value="dinheiro">Carteira em dinheiro</option>
 <option value="cartao">Cart√£o Nubank</option>
 <option value="poupanca">Poupan√ßa</option>
 <option value="trabalho">Trabalho ‚Äì recebimentos</option>
</select>

<h4>Limites</h4>

<div class="filtros">
 <input id="limitePix" placeholder="PIX">
 <input id="limiteDinheiro" placeholder="Dinheiro">
 <input id="limiteCartao" placeholder="Cart√£o">
</div>

<button onclick="criarCarteira()">Cadastrar</button>
</div>

</div>

<!-- D√çVIDAS -->
<div class="tabcontent">

<h3>Quanto cada um me deve</h3>

<div class="card">
 <label>M√™s</label>
 <input id="mesD" type="number">

 <label>Ano</label>
 <input id="anoD" type="number">

 <button onclick="carregarDeve()">Consultar</button>
</div>

<div id="telaDeve" class="resumos"></div>

</div>

<!-- RELATORIOS -->
<div class="tabcontent">
<h3>Movimenta√ß√µes</h3>
<tbody id="tabelaMov"></tbody>
</div>

<!-- RELAT√ìRIOS GERAL -->
<div class="tabcontent">

<h3>Lista</h3>

<button class="btn-outline" onclick="carregarMov()">Recarregar</button>

<table>
<thead>
<tr>
<th>Data</th>
<th>Onde</th>
<th>Descri√ß√£o</th>
<th>Valor</th>
<th>Pagamento</th>
<th>Carteira</th>
<th>Dividido</th>
</tr>
</thead>

<tbody id="tabelaMov"></tbody>
</table>

</div>

<script>
// =============== ABAS ===============
function abrirTab(i){
 document.query.querySelectorAll('.tab').forEach((t,idx)=>
  t.classList.toggle('active', idx===i)
 );

 document.querySelectorAll('.tabcontent').forEach((c,idx)=>
  c.classList.toggle('active', idx===i)
 );
}

// ============== SUPABASE ============
const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

const sb = supabase.createClient(
 SUPABASE_URL,
 SUPABASE_KEY,
 {
  auth:{ persistSession:false }
 }
);

// ============== CRIAR PESSOA ========
async function criarPessoa(){
 await sb.from('pessoas').insert({
  nome:nomePessoa.value,
  tipo:tipoPessoa.value
 });

 nomePessoa.value="";
 carregarPessoas();
}

// ============== CARREGAR PESSOAS ====
async function carregarPessoas(){

 const r = await sb.from('pessoas').select('*');
 const data = r.data||[];

 listaPessoas.innerHTML =
 data.map(p=>
  `<div class='card'>${p.nome} ‚Äî ${p.tipo}</div>`
 ).join('');

 outraPessoa.innerHTML =
 "<option value=''>S√≥ minha</option>"+
 data.map(p=> `<option value='${p.id}'>${p.nome}</option>`).join("");
}

// ============== CRIAR CARTEIRA ======
async function criarCarteira(){

 await sb.from('carteiras').insert({
  nome:nomeCarteira.value,
  saldo:parseFloat(saldoCarteira.value||0),
  tipo:tipoCarteira.value,
  limite_pix:parseFloat(limitePix.value||0),
  limite_dinheiro:parseFloat(limiteDinheiro.value||0),
  limite_cartao:parseFloat(limiteCartao.value||0)
 });

 carregarCarteiras();
}

// ============== CARREGAR CARTEIRAS ==
async function carregarCarteiras(){
 const r = await sb.from('carteiras').select('*');
 const data = r.data||[];

 carteiraMov.innerHTML =
 data.map(c=> `<option value='${c.id}'>${c.nome}</option>`).join("");

 listaCarteiras.innerHTML =
 data.map(c=> `<div class='card'>${c.nome} ‚Äî saldo R$ ${c.saldo}</div>`).join("");
}

// ============== INCLUIR MOV =========
async function incluirMov(){

 const valor = parseFloat(valorMov.value||0);

 await sb.from('movimentacoes').insert({
  data:dataMov.value,
  onde:ondeMov.value,
  descricao:descMov.value,
  valor,
  carteira_id:carteiraMov.value,
  modo_pagamento:modoPag.value,
  a_vista:avista.value==="sim",
  parcelado:dividido.value==="sim",
  parcelas:parseFloat(parcelas.value||1),
  dividido:dividido.value==="sim",
  outra_pessoa_id:outraPessoa.value||null,
  observacao:obsMov.value||null
 });

 carregarMov();
}

// ============== CARREGAR MOV ========
async function carregarMov(){

 const r =
  await sb.from('movimentacoes')
   .select('* , pessoas(nome) , carteiras(nome)')
   .order('data', { ascending:false });

 const data = r.data||[];

 tabelaMov.innerHTML =
 data.map(m=>
  `<tr>
   <td>${new Date(m.data).toLocaleString()}</td>
   <td>${m.onde}</td>
   <td>${m.descricao}</td>
   <td>${m.valor}</td>
   <td>${m.modo_pagamento}</td>
   <td>${m.carteiras?.nome}</td>
   <td>${m.dividido}</td>
  </tr>`
 ).join("");
}

// ============== SQL DEVE ============
async function carregarDeve(){

 const mes = mesD.value;
 const ano = anoD.value;

 const r = await sb.rpc('fn_total_deve');
 const data = r.data||[];

 telaDeve.innerHTML =
 data.map(p=>
  `<div class='card deve'>
    ${p.nome}<br>
    Total: R$ ${p.total}
   </div>`
 ).join("");
}

// ============== INIT =================
carregarPessoas();
carregarCarteiras();
carregarMov();

</script>

</body>
</html>
