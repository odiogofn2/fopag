<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Financeiro</title>

<!-- Supabase UMD (local ou CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.37.0/dist/supabase.min.js"></script>

<style>
:root {
  --bg:#f1f3f6;
  --white:#ffffff;
  --border:#e0e0e0;
  --text:#2c3e50;
  --muted:#7f8c8d;
  --primary:#3498db;
}

* { box-sizing:border-box; }

body {
 margin:0;
 font-family:'Segoe UI', Arial;
 background:var(--bg);
 color:var(--text);
}

.container {
 width:90%;
 max-width:1100px;
 margin:15px auto;
}

header {
 font-size:22px;
 font-weight:600;
 margin:10px 0;
 text-align:center;
}

/* ABAS */
.tabs {
 display:flex;
 gap:4px;
 margin-bottom:6px;
}

.tab {
 padding:8px 12px;
 background:#e9ecf0;
 cursor:pointer;
 border-radius:10px 10px 0 0;
 font-size:14px;
}

.tab.active {
 background:var(--white);
 border:1px solid var(--border);
 border-bottom:none;
 font-weight:bold;
}

.tabcontent {
 display:none;
 background:var(--white);
 padding:12px;
 border-radius:0 10px 10px 10px;
 border:1px solid var(--border);
 box-shadow:0 2px 6px rgba(0,0,0,.06);
 margin-bottom:10px;
}

.tabcontent.active { display:block; }

/* CARDS */
.card {
 background:var(--white);
 padding:10px;
 margin:6px 0;
 border-radius:14px;
 border:1px solid var(--border);
}

.row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.filtros { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }

input,select {
 padding:8px;
 border:1px solid var(--border);
 border-radius:10px;
 margin-bottom:6px;
}

button {
 padding:8px;
 border:none;
 border-radius:10px;
 cursor:pointer;
 font-weight:bold;
 background:var(--primary);
 color:#fff;
}

table {
 width:100%;
 border-collapse:collapse;
 margin-top:6px;
}

th {
 background:#fafafa;
}

th,td {
 border:1px solid var(--border);
 padding:6px;
 font-size:13px;
 text-align:center;
}
</style>

</head>

<body>
<div class="container">

<header>üí∞ Controle das Minhas Finan√ßas</header>

<div class="tabs">
 <div class="tab active" onclick="abrirTab(0)">Carteiras</div>
 <div class="tab" onclick="abrirTab(1)">Pessoas</div>
 <div class="tab" onclick="abrirTab(2)">Movimenta√ß√µes</div>
 <div class="tab" onclick="abrirTab(3)">Relat√≥rios</div>
</div>

<!-- ABA CARTEIRAS -->
<div class="tabcontent active">
<h3>Minhas Carteiras</h3>
<div id="listaCarteiras"></div>

<h4>Nova carteira</h4>
<input id="nomeCarteira" placeholder="Nome da carteira">
<div class="row">
 <input id="saldoCarteira" placeholder="Saldo inicial" type="number">
 <select id="tipoCarteira">
  <option value="conta">Conta</option>
  <option value="cartao">Cart√£o</option>
  <option value="dinheiro">Dinheiro</option>
  <option value="investimento">Investimento</option>
  <option value="banca">Banca</option>
 </select>
</div>
<div class="filtros">
 <input id="limitePix" placeholder="Limite PIX" type="number">
 <input id="limiteDinheiro" placeholder="Limite Dinheiro" type="number">
 <input id="limiteCartao" placeholder="Limite Cart√£o" type="number">
</div>
<button onclick="criarCarteira()">Cadastrar carteira</button>
</div>

<!-- ABA PESSOAS -->
<div class="tabcontent">
<h3>Pessoas</h3>
<div id="listaPessoas"></div>
<input id="nomePessoa" placeholder="Nome da pessoa">
<select id="tipoPessoa">
 <option value="amigo">Amigo</option>
 <option value="familia">Fam√≠lia</option>
 <option value="cliente">Cliente</option>
</select>
<button onclick="criarPessoa()">Cadastrar pessoa</button>
</div>

<!-- ABA MOVIMENTA√á√ïES -->
<div class="tabcontent">
<h3>Incluir Movimenta√ß√£o</h3>
<input id="dataMov" type="datetime-local">
<input id="ondeMov" placeholder="Onde foi">
<input id="descMov" placeholder="O que foi">
<input id="valorMov" placeholder="Valor" type="number">
<select id="carteiraMov"></select>
<select id="modoPag">
 <option value="pix">PIX</option>
 <option value="cartao">Cart√£o</option>
 <option value="dinheiro">Dinheiro</option>
 <option value="transferencia">Transfer√™ncia</option>
</select>
<div class="row">
 <select id="forma">
  <option value="avista">√Ä vista</option>
  <option value="parcelado">Parcelado</option>
 </select>
 <input id="qtdParcelas" placeholder="N¬∫ parcelas" type="number">
</div>
<div class="row">
 <select id="dividiu">
  <option value="nao">N√£o dividi</option>
  <option value="sim">Dividi com algu√©m</option>
 </select>
 <select id="pessoasDivididas" multiple></select>
</div>
<input id="obsMov" placeholder="Observa√ß√£o">
<button onclick="incluirMov()">Registrar</button>
</div>

<!-- ABA RELAT√ìRIOS -->
<div class="tabcontent">
<h3>Relat√≥rio</h3>
<div class="filtros">
 <input id="mesFiltro" placeholder="M√™s" type="number">
 <input id="anoFiltro" placeholder="Ano" type="number">
 <select id="carteiraFiltro"></select>
</div>
<button onclick="carregarMov()">Filtrar</button>
<table>
<thead>
<tr>
 <th>Data</th>
 <th>Onde</th>
 <th>Descri√ß√£o</th>
 <th>Valor</th>
 <th>Pagamento</th>
 <th>Carteira</th>
 <th>Dividido</th>
 <th>% por pessoa</th>
</tr>
</thead>
<tbody id="tabelaMov"></tbody>
</table>
</div>

<script>
// =============== ABAS =================
function abrirTab(i){
 document.querySelectorAll('.tab').forEach((t,idx)=> t.classList.toggle('active',idx===i));
 document.querySelectorAll('.tabcontent').forEach((c,idx)=> c.classList.toggle('active',idx===i));
}

// =============== SUPABASE =================
const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// =============== PESSOAS =================
async function criarPessoa(){
 const nome = document.getElementById("nomePessoa").value;
 const tipo = document.getElementById("tipoPessoa").value;
 if(!nome) return alert("Informe o nome");
 await supabaseClient.from("pessoas").insert([{nome,tipo}]);
 document.getElementById("nomePessoa").value="";
 carregarPessoas();
}
async function carregarPessoas(){
 const {data} = await supabaseClient.from("pessoas").select("*");
 document.getElementById("listaPessoas").innerHTML = data.map(p=>`<div class="card">${p.nome} (${p.tipo})</div>`).join("");
 document.getElementById("pessoasDivididas").innerHTML = data.map(p=>`<option value="${p.id}">${p.nome}</option>`).join("");
}

// =============== CARTEIRAS =================
async function criarCarteira(){
 const nome = document.getElementById("nomeCarteira").value;
 const saldo = parseFloat(document.getElementById("saldoCarteira").value||0);
 const tipo = document.getElementById("tipoCarteira").value;
 const limite_pix = parseFloat(document.getElementById("limitePix").value||0);
 const limite_dinheiro = parseFloat(document.getElementById("limiteDinheiro").value||0);
 const limite_cartao = parseFloat(document.getElementById("limiteCartao").value||0);
 await supabaseClient.from("carteiras").insert([{nome,saldo,tipo,limite_pix,limite_dinheiro,limite_cartao}]);
 document.getElementById("nomeCarteira").value="";
 document.getElementById("saldoCarteira").value="";
 carregarCarteiras();
}
async function carregarCarteiras(){
 const {data} = await supabaseClient.from("carteiras").select("*");
 document.getElementById("listaCarteiras").innerHTML = data.map(c=>`<div class="card">${c.nome}<br>Saldo: R$ ${c.saldo.toFixed(2)}</div>`).join("");
 const options = data.map(c=>`<option value="${c.id}">${c.nome}</option>`).join("");
 document.getElementById("carteiraMov").innerHTML = options;
 document.getElementById("carteiraFiltro").innerHTML = options;
}

// =============== MOVIMENTA√á√ïES =================
async function incluirMov(){
 const data = document.getElementById("dataMov").value;
 const onde = document.getElementById("ondeMov").value;
 const descricao = document.getElementById("descMov").value;
 const valor = parseFloat(document.getElementById("valorMov").value||0);
 const carteira_id = document.getElementById("carteiraMov").value;
 const modo_pagamento = document.getElementById("modoPag").value;
 const a_vista = document.getElementById("forma").value==="avista";
 const parcelado = document.getElementById("forma").value==="parcelado";
 const parcelas = parseInt(document.getElementById("qtdParcelas").value||1);
 const dividiu = document.getElementById("dividiu").value==="sim";
 const pessoas_ids = Array.from(document.getElementById("pessoasDivididas").selectedOptions).map(o=>o.value);
 const observacao = document.getElementById("obsMov").value;

 let outra_pessoa_id = null;
 if(dividiu && pessoas_ids.length===1) outra_pessoa_id = pessoas_ids[0];

 await supabaseClient.from("movimentacoes").insert([{
   data,onde,descricao,valor,carteira_id,modo_pagamento,
   a_vista,parcelado,parcelas,dividido:dividiu,
   observacao,outra_pessoa_id
 }]);

 // atualiza saldo se for √† vista e n√£o dividido
 if(a_vista && !dividiu){
   const {data:c} = await supabaseClient.from("carteiras").select("*").eq("id",carteira_id).single();
   await supabaseClient.from("carteiras").update({saldo:c.saldo-valor}).eq("id",carteira_id);
 }

 // limpa campos
 document.getElementById("dataMov").value="";
 document.getElementById("ondeMov").value="";
 document.getElementById("descMov").value="";
 document.getElementById("valorMov").value="";
 document.getElementById("obsMov").value="";
 carregarCarteiras();
 carregarMov();
}

// =============== RELAT√ìRIO =================
async function carregarMov(){
 const mes = parseInt(document.getElementById("mesFiltro").value);
 const ano = parseInt(document.getElementById("anoFiltro").value);
 const carteira_id = document.getElementById("carteiraFiltro").value;

 let query = supabaseClient.from("movimentacoes")
   .select("*,pessoas(nome),carteiras(nome)")
   .order("data",{ascending:false});

 if(!isNaN(mes)) query = query.filter('data','gte',new Date(ano,mes-1,1)).filter('data','lt',new Date(ano,mes,1));
 if(carteira_id) query = query.eq('carteira_id',carteira_id);

 const {data} = await query;

 document.getElementById("tabelaMov").innerHTML = data.map(m=>{
   let percentual = "100%";
   if(m.dividido){
     const qtd = m.outra_pessoa_id?2:m.pessoas_ids?.length || 1;
     percentual = (100/qtd).toFixed(2)+"%";
   }
   return `<tr>
     <td>${new Date(m.data).toLocaleString()}</td>
     <td>${m.onde}</td>
     <td>${m.descricao}</td>
     <td>R$ ${m.valor.toFixed(2)}</td>
     <td>${m.modo_pagamento}</td>
     <td>${m.carteiras?.nome||''}</td>
     <td>${m.dividido?'Sim':'N√£o'}</td>
     <td>${percentual}</td>
   </tr>`;
 }).join("");
}

// =============== INIT =================
carregarPessoas();
carregarCarteiras();
carregarMov();
</script>

</body>
</html>
