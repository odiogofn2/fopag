<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Financeiro</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

<style>
:root {
  --bg:#f1f3f6;
  --white:#ffffff;
  --border:#e0e0e0;
  --text:#2c3e50;
  --muted:#7f8c8d;
}

* { box-sizing:border-box; }

body {
 margin:0;
 font-family:'Segoe UI', Arial;
 background:var(--bg);
 color:var(--text);
}

.container {
 width:92%;
 max-width:1100px;
 margin:15px auto;
}

header {
 font-size:22px;
 font-weight:600;
 margin:10px 0;
}

.tabs { display:flex; gap:4px; }

.tab {
 padding:8px 12px;
 background:#e9ecf0;
 cursor:pointer;
 border-radius:10px 10px 0 0;
 font-size:14px;
}

.tab.active {
 background:var(--white);
 border:1px solid var(--border);
 border-bottom:none;
 font-weight:bold;
}

.tabcontent {
 display:none;
 background:var(--white);
 padding:12px;
 border-radius:0 10px 10px 10px;
 border:1px solid var(--border);
 box-shadow:0 2px 6px rgba(0,0,0,.06);
 margin-bottom:10px;
}

.tabcontent.active { display:block; }

.card {
 background:var(--white);
 padding:10px;
 margin:6px 0;
 border-radius:14px;
 border:1px solid var(--border);
}

.row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.filtros { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }

input,select {
 padding:8px;
 border:1px solid var(--border);
 border-radius:10px;
 margin-bottom:6px;
}

button {
 padding:8px;
 border:none;
 border-radius:10px;
 cursor:pointer;
 font-weight:bold;
}

table { width:100%; border-collapse:collapse; }
th { background:#fafafa; }

th,td {
 border:1px solid var(--border);
 padding:6px;
 font-size:13px;
}
</style>
</head>

<body>
<div class="container">

<header>üí∞ Controle das Minhas Finan√ßas</header>

<div class="tabs">
 <div class="tab active" onclick="abrirTab(0)">Carteiras</div>
 <div class="tab" onclick="abrirTab(1)">Pessoas</div>
 <div class="tab" onclick="abrirTab(2)">Movimenta√ß√£o</div>
 <div class="tab" onclick="abrirTab(3)">Relat√≥rios</div>
 <div class="tab" onclick="abrirTab(4)">Quem me Deve</div>
</div>

<div class="tabcontent active">
 <h3>Minhas Carteiras</h3>
 <div id="listaCarteiras"></div>
</div>

<div class="tabcontent">
 <h3>Pessoas</h3>
 <div id="listaPessoas"></div>
</div>

<div class="tabcontent">
 <h3>Incluir Movimenta√ß√£o</h3>
 <input id="dataMov" type="datetime-local">
 <input id="ondeMov" placeholder="Onde foi">
 <input id="descMov" placeholder="O que foi">
 <input id="valorMov" type="number">
 <button onclick="incluirMov()">Registrar</button>
</div>

<div class="tabcontent">
 <h3>Relat√≥rios</h3>
 <tbody id="tabelaMov"></tbody>
</div>

<!-- ==== ABA QUEM ME DEVE ==== -->
<div class="tabcontent">

<h3>üë• Quem me Deve</h3>

<div class="row">
 <input id="fmes" placeholder="M√™s" type="number">
 <input id="fano" placeholder="Ano" type="number">
</div>

<button onclick="carregarDevedores()">Filtrar D√©bitos</button>

<table>
<thead>
<tr>
 <th>Pessoa</th>
 <th>Ano</th>
 <th>M√™s</th>
 <th>Total Devido</th>
 <th>A√ß√£o</th>
</tr>
</thead>

<tbody id="tabelaDevedores"></tbody>
</table>

<div id="totalGeral"></div>
<div id="msgErro"></div>

</div>

<script defer>
// ======== SUPABASE ========
const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

let db;

window.addEventListener("load", ()=>{
 db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
 iniciar();
});

function iniciar(){
 carregarPessoas();
 carregarCarteiras();
 carregarMov();
}

// ======== ABAS ========
function abrirTab(i){
 document.querySelectorAll(".tab").forEach((t,idx)=>
   t.classList.toggle("active", idx===i));

 document.querySelectorAll(".tabcontent").forEach((c,idx)=>
   c.classList.toggle("active", idx===i));
}

// ======== CARREGAR DEV ========
async function carregarDevedores(){

 try {

 let { data, error } = await db.rpc("fn_devedores_mensal");

 if(error) throw error;

 const mes = fmes.value;
 const ano = fano.value;

 if(ano) data = data.filter(d=> d.ano==ano);
 if(mes) data = data.filter(d=> d.mes==mes);

 renderDevedores(data);

 } catch(e){
   msgErro.innerText = "Erro ao carregar: " + e.message;
 }

}

function renderDevedores(data){

 tabelaDevedores.innerHTML =
 data.map(d=>`
  <tr>
   <td>${d.pessoa}</td>
   <td>${d.ano}</td>
   <td>${d.mes}</td>
   <td>R$ ${parseFloat(d.total).toFixed(2)}</td>

   <td>
    <button onclick="quitar('${d.pessoa_id}',${d.ano},${d.mes},${d.total})">
      Quitar
    </button>
   </td>

  </tr>
 `).join("");

 totalGeral.innerText =
 "Total geral: R$ " +
 data.reduce((s,d)=> s+parseFloat(d.total),0).toFixed(2);

}


// ======== A√á√ÉO QUITAR ========
async function quitar(pessoa_id,ano,mes,total){

 await db.rpc("fn_quitar_periodo",{
  p_pessoa:pessoa_id,
  p_ano:ano,
  p_mes:mes,
  p_total:total
 });

 alert("Quita√ß√£o registrada!");
 carregarDevedores();
}


// ======== RESTO ========
async function carregarPessoas(){ const {data}=await db.from("pessoas").select("*"); }
async function carregarCarteiras(){ const {data}=await db.from("carteiras").select("*"); }
async function carregarMov(){ const {data}=await db.from("movimentacoes").select("*"); }
async function carregarMov(){ const {data}=await db.from("movimentacoes").select("*"); }

</script>

</body>
</html>

