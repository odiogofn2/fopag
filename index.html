<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<title>Controle Financeiro</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

<style>
body{
  background:#f4f6f8;
  font-family:system-ui, -apple-system, Segoe UI, Roboto;
  margin:0;
}

.container{
  max-width:1100px;
  margin:20px auto;
  background:#fff;
  padding:16px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}

.abas{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.tab{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #e0e3e7;
  background:#fff;
  cursor:pointer;
  font-size:14px;
}

.tab.active{
  background:#2563eb;
  color:#fff;
}

.tabcontent{
  display:none;
  margin-top:12px;
}

.tabcontent.active{
  display:block;
}

.form-grid{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:8px;
}

input,select{
 width:100%;
 padding:8px;
 border-radius:10px;
 border:1px solid #e0e3e7;
}

.btn{
 padding:8px 12px;
 border-radius:10px;
 border:none;
 cursor:pointer;
}

.btn.blue{
 background:#2563eb;
 color:#fff;
}

.btn.green{
 background:#16a34a;
 color:#fff;
}

.card{
 border:1px solid #e0e3e7;
 border-radius:12px;
 padding:10px;
 margin-bottom:8px;
}

.tabela{
 width:100%;
 border-collapse:collapse;
}

.tabela th, .tabela td{
 border-bottom:1px solid #e5e7eb;
 padding:6px;
 text-align:left;
 font-size:13px;
}

.top-bar{
 display:flex;
 justify-content:space-between;
 align-items:center;
}
</style>
</head>

<body>

<div class="container">

<div class="abas">
 <button class="tab active" onclick="abrirTab(0)">Movimentações</button>
 <button class="tab" onclick="abrirTab(1)">Carteiras</button>
 <button class="tab" onclick="abrirTab(2)">Pessoas</button>
 <button class="tab" onclick="abrirTab(3)">Quem me Deve</button>
</div>

<!-- ===== MOVIMENTAÇÕES ===== -->
<div class="tabcontent active">

<div class="top-bar">
 <h3>Nova Movimentação</h3>
</div>

<div class="form-grid card">
 <div>
  <label>Data</label>
  <input id="dt" type="date"/>
 </div>

 <div>
  <label>Onde</label>
  <input id="onde"/>
 </div>

 <div>
  <label>O que</label>
  <input id="oque"/>
 </div>

 <div>
  <label>Valor</label>
  <input id="valor" type="number" step="0.01"/>
 </div>

 <div>
  <label>Modo</label>
  <select id="modo">
   <option>pix</option>
   <option>cartao</option>
   <option>dinheiro</option>
  </select>
 </div>

 <div>
  <label>Tipo</label>
  <select id="avista">
   <option value="true">À vista</option>
   <option value="false">Parcelado</option>
  </select>
 </div>

 <div>
  <label>De outra pessoa?</label>
  <select id="outra">
   <option value="false">Só meu</option>
   <option value="true">Outra pessoa</option>
  </select>
 </div>

 <div>
  <label>Dividido?</label>
  <select id="dividido">
   <option value="false">Não</option>
   <option value="true">Sim</option>
  </select>
 </div>

</div>

<button class="btn blue" onclick="salvarMov()">Cadastrar</button>

<h4>Registros</h4>
<div id="listaMov"></div>

</div>

<!-- ===== CARTEIRAS ===== -->
<div class="tabcontent">

<div class="top-bar">
 <h3>Criar Carteira</h3>
</div>

<div class="card">
 <input id="carNome" placeholder="Nome da carteira"/>
 <input id="limPix" type="number" placeholder="Limite PIX"/>
 <input id="limCartao" type="number" placeholder="Limite Cartão"/>
 <input id="limDin" type="number" placeholder="Limite Dinheiro"/>
</div>

<button class="btn green" onclick="salvarCarteira()">Criar</button>

<div id="listaCarteiras"></div>

</div>

<!-- ===== PESSOAS ===== -->
<div class="tabcontent">

<div class="top-bar">
 <h3>Cadastrar Pessoa</h3>
</div>

<div class="card">
 <input id="pesNome" placeholder="Nome da pessoa"/>
 <input id="pesContato" placeholder="Contato"/>
</div>

<button class="btn blue" onclick="salvarPessoa()">Salvar Pessoa</button>

<div id="listaPessoas"></div>

</div>

<!-- ===== QUEM ME DEVE ===== -->
<div class="tabcontent">

<div class="top-bar">
 <h3>Consulta de Devedores</h3>
 <div>
  <select id="fmes">
   <option value="1">Janeiro</option>
   <option value="2">Fevereiro</option>
   <option value="3">Março</option>
   <option value="4">Abril</option>
   <option value="5">Maio</option>
   <option value="6">Junho</option>
   <option value="7">Julho</option>
   <option value="8">Agosto</option>
   <option value="9">Setembro</option>
   <option value="10">Outubro</option>
   <option value="11">Novembro</option>
   <option value="12">Dezembro</option>
  </select>

  <select id="fano">
   <option>2024</option>
   <option>2025</option>
   <option selected>2026</option>
  </select>

  <button class="btn blue" onclick="carregarDevedores()">Consultar</button>
 </div>
</div>

<div class="card">
 <strong>Total Geral:</strong>
 <span id="totalGeral">0,00</span>
</div>

<table class="tabela">
<thead>
 <tr>
  <th>Pessoa</th>
  <th>Mês</th>
  <th>Ano</th>
  <th>Total</th>
  <th></th>
 </tr>
</thead>

<tbody id="tabelaDevedores"></tbody>
</table>

<div id="msgErro"></div>

</div>

</div>

<!-- ===== SCRIPT ===== -->
<script defer>

const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

let db;

window.addEventListener("load", ()=>{

 db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

 carregarCarteiras();
 carregarPessoas();
 carregarLista();

 document.getElementById("dt").value =
   new Date().toISOString().substring(0,10);

});

// ===== ABAS =====
function abrirTab(i){
 document.querySelectorAll(".tab")
   .forEach((t,idx)=> t.classList.toggle("active", idx===i));

 document.querySelectorAll(".tabcontent")
   .forEach((c,idx)=> c.classList.toggle("active", idx===i));
}

// ===== CARREGAR =====
async function carregarCarteiras(){
 const {data} = await db.from("carteiras").select("*");
 const d = document.getElementById("listaCarteiras");
 d.innerHTML = data.map(x=>
   `<div class='card'>${x.nome}</div>`).join("");
}

async function carregarPessoas(){
 const {data} = await db.from("pessoas").select("*");
 const d = document.getElementById("listaPessoas");
 d.innerHTML = data.map(x=>
   `<div class='card'>${x.nome}</div>`).join("");
}

async function carregarLista(){
 const {data} = await db.from("movimentacoes")
     .select("*").order("dt",{ascending:false});

 const d = document.getElementById("listaMov");
 d.innerHTML = dataAbaMov(data);
}

function Rquitar(id,ano,mes,total){
 quitar(id,ano,mes,total);
}

// ===== SALVAR =====
async function salvarCarteira(){
 await db.from("carteiras").insert({
  nome: carNome.value,
  limite_pix: limPix.value||0,
  limite_cartao: limCartao.value||0,
  limite_dinheiro: limDin.value||0
 });

 carregarCarteiras();
}

async function salvarPessoa(){
 await db.from("pessoas").insert({
   nome: pesNome.value,
   contato: pesContato.value
 });

 carregarPessoas();
}

async function salvarMov(){

 await db.from("movimentacoes").insert({
  dt: dt.value,
  onde: onde.value,
  oque: oque.value,
  valor: parseFloat(valor.value||0),
  modo: modo.value,
  avista: avista.value==="true",
  outra_pessoa: outra.value==="true",
  dividido: dividido.value==="true"
 });

 carregarLista();
}

// ===== TEMPLATE =====
function Rmes(m){
 const map=["","Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
 return map[m];
}

function Rita(valor){
 return parseFloat(valor||0)
   .toLocaleString("pt-BR",{minimumFractionDigits:2});
}

function RitaLin(x){
 return `
 <div class='card form-grid'>
  <div>${x.dt}</div>
  <div>${x.onde}</div>
  <div>${x.oque}</div>
  <div>R$ ${Rita(x.valor)}</div>
  <div>${x.modo}</div>
 </div>`;
}

function RitaAbaMov(data){
 return data.map(RitaLin).join("");
}

// ===== DEVEDORES =====
async function carregarDevedores(){

 const ano = parseInt(fano.value);
 const mes = parseInt(fmes.value);

 const {data,error} =
   await db.from("devedores_view")
     .select("*")
     .eq("ano",ano)
     .eq("mes",mes);

 if(error){
   msgErro.innerText = error.message;
   return;
 }

 document.getElementById("totalGeral").innerText =
   data.reduce((s,x)=>s+ (x.total||0),0);

 const t = document.getElementById("tabelaDevedores");

 t.innerHTML = data.map(x=>`
 <tr>
  <td>${x.nome}</td>
  <td>${Rmes(x.mes)}</td>
  <td>${x.ano}</td>
  <td>R$ ${Rita(x.total)}</td>
  <td>
   <button class='btn green'
     onclick='Rquitar(${x.pessoa_id},${x.ano},${x.mes},${x.total})'>
     Quitar
   </button>
  </td>
 </tr>`).join("");

}

// ===== RESPEITAR LAYOUT =====
function RabaMov(data){
 return data.map(RitaLin).join("");
}

</script>

</body>
</html>

