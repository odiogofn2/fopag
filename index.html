<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle Financeiro</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#f1f3f6;
  --white:#ffffff;
  --border:#e0e0e0;
  --text:#2c3e50;
  --muted:#7c7c7c;
  --primary:#111827;
  --success:#059669;
}

* { box-sizing:border-box; }

body {
 margin:0;
 font-family:'Segoe UI', Arial;
 background:var(--bg);
 color:var(--text);
}

.container {
 width:92%;
 max-width:1100px;
 margin:15px auto;
}

header {
 font-size:22px;
 font-weight:600;
 margin:10px 0;
}

/* ABAS */
.tabs { display:flex; gap:4px; }
.tab {
 padding:8px 12px;
 background:#e9ecf0;
 cursor:pointer;
 border-radius:12px 12px 0 0;
 font-size:14px;
 transition:.2s;
}
.tab.active {
 background:var(--white);
 border:1px solid var(--border);
 border-bottom:none;
 font-weight:bold;
}
.tabcontent {
 display:none;
 background:var(--white);
 padding:14px;
 border-radius:0 12px 12px 12px;
 border:1px solid var(--border);
 box-shadow:0 4px 10px rgba(0,0,0,.06);
 margin-bottom:10px;
}
.tabcontent.active { display:block; }

/* CARDS */
.card {
 background:var(--white);
 padding:12px;
 margin:8px 0;
 border-radius:16px;
 border:1px solid var(--border);
 box-shadow:0 2px 6px rgba(0,0,0,.04);
}

.row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.filtros { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }

input,select {
 padding:8px;
 border:1px solid var(--border);
 border-radius:12px;
 margin-bottom:6px;
}

button {
 padding:8px 12px;
 border:none;
 border-radius:12px;
 cursor:pointer;
 font-weight:bold;
 background:var(--primary);
 color:white;
}

button:hover{ opacity:.9; }

/* TABELA */
table {
 width:100%;
 border-collapse:collapse;
 margin-top:8px;
 background:white;
 border-radius:14px;
 overflow:hidden;
}
th {
 background:#fafafa;
 font-size:13px;
}
th,td {
 border:1px solid var(--border);
 padding:8px;
 font-size:13px;
}

.btn-quitar{
 background:var(--success);
 color:white;
}

</style>
</head>

<body>
<div class="container">
<header>üí∞ Controle das Minhas Finan√ßas</header>

<div class="tabs">
 <div class="tab active" onclick="abrirTab(0)">Carteiras</div>
 <div class="tab" onclick="abrirTab(1)">Pessoas</div>
 <div class="tab" onclick="abrirTab(2)">Movimenta√ß√£o</div>
 <div class="tab" onclick="abrirTab(3)">Relat√≥rios</div>
 <div class="tab" onclick="abrirTab(4)">Quem me deve</div>
</div>

<!-- ABA CARTEIRAS -->
<div class="tabcontent active">
<h3>Minhas Carteiras</h3>
<div id="listaCarteiras"></div>

<h4>Nova carteira</h4>
<input id="nomeCarteira" placeholder="Nome da carteira">

<div class="row">
 <input id="saldoCarteira" placeholder="Saldo inicial" type="number">
 <select id="tipoCarteira">
  <option value="conta">Conta</option>
  <option value="cartao">Cart√£o</option>
  <option value="dinheiro">Dinheiro</option>
  <option value="investimento">Investimento</option>
  <option value="banca">Banca</option>
 </select>
</div>

<div class="filtros">
 <input id="limitePix" placeholder="Limite PIX" type="number">
 <input id="limiteDinheiro" placeholder="Limite Dinheiro" type="number">
 <input id="limiteCartao" placeholder="Limite Cart√£o" type="number">
</div>

<button onclick="criarCarteira()">Cadastrar carteira</button>
</div>


<!-- ABA PESSOAS -->
<div class="tabcontent">
<h3>Pessoas</h3>
<div id="listaPessoas"></div>
<input id="nomePessoa" placeholder="Nome da pessoa">
<select id="tipoPessoa">
 <option value="pessoal">Pessoal</option>
 <option value="amigo">Amigo</option>
 <option value="familia">Fam√≠lia</option>
 <option value="cliente">Cliente</option>
</select>
<button onclick="criarPessoa()">Cadastrar pessoa</button>
</div>


<!-- ABA MOVIMENTA√á√ÉO -->
<div class="tabcontent">
<h3>Incluir Movimenta√ß√£o</h3>
<input id="dataMov" type="datetime-local">
<input id="ondeMov" placeholder="Onde foi">
<input id="descMov" placeholder="O que foi">
<input id="valorMov" placeholder="Valor" type="number">
<select id="carteiraMov"></select>

<select id="modoPag">
 <option value="pix">PIX</option>
 <option value="cartao">Cart√£o</option>
 <option value="dinheiro">Dinheiro</option>
 <option value="transferencia">Transfer√™ncia</option>
</select>

<div class="row">
 <select id="forma">
  <option value="avista">√Ä vista</option>
  <option value="parcelado">Parcelado</option>
 </select>
 <input id="qtdParcelas" placeholder="N¬∫ parcelas" type="number">
</div>

<select id="outraPessoa">
 <option value="">Despesa s√≥ minha</option>
</select>

<div class="row">
 <select id="dividiu">
  <option value="nao">N√£o dividi</option>
  <option value="sim">Dividi com algu√©m</option>
 </select>
 <select id="pessoaRateio"></select>
</div>

<input id="obsMov" placeholder="Observa√ß√£o">
<button onclick="incluirMov()">Registrar</button>
</div>


<!-- ABA RELAT√ìRIOS -->
<div class="tabcontent">
<h3>Relat√≥rio</h3>
<div class="filtros">
 <input id="mesFiltro" placeholder="M√™s" type="number">
 <input id="anoFiltro" placeholder="Ano" type="number">
 <select id="carteiraFiltro"></select>
</div>
<button onclick="carregarMov()">Filtrar</button>

<table>
<thead>
<tr>
 <th>Data</th>
 <th>Onde</th>
 <th>Descri√ß√£o</th>
 <th>Valor</th>
 <th>Pagamento</th>
 <th>Carteira</th>
 <th>Dividido</th>
</tr>
</thead>
<tbody id="tabelaMov"></tbody>
</table>
</div>


<!-- ABA QUEM ME DEVE -->
<div class="tabcontent">
<h3>Contas a Receber por M√™s/Ano</h3>

<div class="card">
 <div class="row">
  <input id="fmes" placeholder="M√™s" type="number">
  <input id="fano" placeholder="Ano" type="number">
 </div>
 <button onclick="carregarDevedores()">Filtrar per√≠odo</button>
</div>

<table>
<thead>
<tr>
 <th>Pessoa</th>
 <th>Ano</th>
 <th>M√™s</th>
 <th>Total Devido</th>
 <th>A√ß√£o</th>
</tr>
</tbody id="tbodyDev"></tbody>
</table>

</div>


<script>
// ================= ABAS ==================
function abrirTab(i) {
 document.querySelectorAll('.tab').forEach((t,idx)=>
   t.classList.toggle('active', idx===i)
 );
 document.querySelectorAll('.tabcontent').forEach((c,idx)=>
   c.classList.toggle('active', idx===i)
 );
}


// ============== SUPABASE =================
const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


// ============== DEVEDORES ================
async function carregarDevedores(){
 let { data } = await db.rpc('fn_devedores_mensal');

 const mes = document.getElementById('fmes').value;
 const ano = document.getElementById('fano').value;

 if(ano) data = data.filter(d=> d.ano==ano);
 if(mes) data = data.filter(d=> d.mes==mes);

 renderDevedores(data||[]);
}

function renderDevedores(data){
 document.getElementById('tbodyDev').innerHTML = data.map(d=>
  `<tr>
    <td>${d.pessoa}</td>
    <td>${d.ano}</td>
    <td>${d.mes}</td>
    <td>R$ ${parseFloat(d.total).toFixed(2)}</td>
    <td><button class="btn-quitar" onclick="quitarDev('${d.pessoa_id}')">Quitar</button></td>
   </tr>`
 ).join('');
}

async function quitarDev(pessoa_id){
 await db.from('rateios')
  .update({ valor_parte:0 })
  .eq('pessoa_id',pessoa_id);

 alert('Valor quitado para esta pessoa');
 carregarDevedores();
}


// ============== PESSOAS ==================
async function criarPessoa() {
 await db.from("pessoas").insert({
  nome:document.getElementById('nomePessoa').value,
  tipo:document.getElementById('tipoPessoa').value
 });
 document.getElementById('nomePessoa').value="";
 carregarCarteiras();
}


// ============== CARTEIRAS =================
async function criarCarteira() {
 await db.from("carteiras").insert({
  nome:document.getElementById('nomeCarteira').value,
  saldo:parseFloat(document.getElementById('saldoCarteira').value||0),
  limite_pix:parseFloat(document.getElementById('limitePix').value||0),
  limite_dinheiro:parseFloat(document.getElementByById('limiteDinheiro').value||0),
  limite_cartao:parseFloat(document.getElementById('limiteCartao').value||0),
  tipo:document.getElementById('tipoCarteira').value
 });
 document.getElementById('nomeCarteira').value="";
 carregarCarteiras();
}

async function carregarCarteiras(){
 const { data } = await db.from('carteiras').select('*');
 document.getElementById('listaCarteiras').innerHTML = data.map(c=>
  `<div class='card'>${c.nome}<br>Saldo: R$ ${c.saldo.toFixed(2)}</div>`
 ).join('');

 const opts = data.map(c=>
  `<option value='${c.id}'>${c.nome}</option>`).join('');
 document.getElementById('carteiraMov').innerHTML = opts;
 document.getElementById('carteiraFiltro').innerHTML = opts;
}


// ============== MOVIMENTA√á√ïES ============
async function incluirMov() {
 const valor = parseFloat(document.getElementById('valorMov').value||0);

 await db.from("movimentacoes").insert({
  data:document.getElementById('dataMov').value,
  onde:document.getElementById('ondeMov').value,
  descricao:document.getElementById('descMov').value,
  valor,
  carteira_id:document.getElementById('carteiraMov').value,
  modo_pagamento:document.getElementById('modoPag').value,
  a_vista:document.getElementById('forma').value==="avista",
  parcelado:document.getElementById('forma').value==="parcelado",
  parcelas:parseFloat(document.getElementById('qtdParcelas').value||1),
  outra_pessoa_id:document.getElementById('outraPessoa').value||null,
  dividido:document.getElementById('dividiu').value==="sim",
  observacao:document.getElementById('obsMov').value
 });

 const { data:c } = await db
   .from('carteiras')
   .select('*')
   .eq('id', document.getElementById('carteiraMov').value)
   .single();

 await db.from('carteiras')
   .update({ saldo: c.saldo - valor })
   .eq('id', document.getElementById('carteiraMov').value);

 document.getElementById('valorMov').value="";
 document.getElementById('descMov').value="";
 document.getElementById('ondeMov').value="";

 carregarCarteiras();
 carregarDevedores();
}


// ============== RELAT√ìRIOS ================
async function carregarMov() {
 const { data } = await db.from("movimentacoes")
   .select("*, carteiras(nome)")
   .order("data",{ ascending:false });

 document.getElementById("tabelaMov").innerHTML = data.map(m=>
  `<tr>
   <td>${new Date(m.data).toLocaleString()}</td>
   <td>${m.onde}</td>
   <td>${m.descricao}</td>
   <td>R$ ${m.valor.toFixed(2)}</td>
   <td>${m.modo_pagamento}</td>
   <td>${m.carteiras?.nome||''}</td>
   <td>${m.dividido?'Sim':'N√£o'}</td>
  </tr>`
 ).join('');
}


// ============== INIT =======================
carregarCarteiras();
carregarPessoa();
carregarMov();
carregarDevedores();

</script>

</body>
</html>
