<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<title>Controle Financeiro – Diogo FN</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  background:#f5f6fa;
  font-family:system-ui;
}

.container{
  width:95%;
  max-width:1100px;
  margin:auto;
  background:white;
  padding:16px;
  border-radius:12px;
  box-shadow:0 0 10px rgba(0,0,0,.08);
}

.abas{
  display:flex;
  gap:6px;
  border-bottom:1px solid #ddd;
  margin-bottom:10px;
}

.aba{
  padding:8px 12px;
  cursor:pointer;
  border-radius:8px 8px 0 0;
}

.ativa{
  background:#fff;
  border:1px solid #ddd;
  border-bottom:none;
  font-weight:600;
}

.painel{ display:none }
.show{ display:block }

input,select{
  width:100%;
  padding:8px;
  margin:4px 0;
  border:1px solid #ccc;
  border-radius:8px;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.grade{ display:grid; grid-template-columns:1fr 1fr; gap:8px }

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:6px;
  border-bottom:1px solid #eee;
  text-align:left;
}

.card{
  background:#fafafa;
  padding:8px;
  border-radius:10px;
  margin:4px 0;
}
</style>
</head>

<body>
<div class="container">

<h2>Minhas Finanças – Controle Pessoal</h2>

<!-- ABAS -->
<div class="abas">
 <div class="aba ativa" onclick="trocar('t1')" id="a1">Movimentação</div>
 <div class="aba" onclick="trocar('t2')" id="a2">Carteiras</div>
 <div class="aba" onclick="trocar('t3')" id="a3">Pessoas</div>
 <div class="aba" onclick="trocar('t4')" id="a4">Devedores</div>
</div>

<!-- TELA 1 – MOVIMENTAÇÃO -->
<div class="painel show" id="t1">

 <div class="grade">
  <div>
   <label>Onde</label>
   <input id="onde"/>
  </div>

  <div>
   <label>Descrição</label>
   <input id="descricao"/>
  </div>
 </div>

 <div class="grade">
  <div>
   <label>Valor</label>
   <input id="valor" type="number"/>
  </div>

  <div>
   <label>Carteira</label>
   <select id="carteira"></select>
  </div>
 </div>

 <label>Modo de pagamento</label>
 <select id="modo">
  <option>pix</option>
  <option>cartao</option>
  <option>dinheiro</option>
 </select>

 <div class="grade">
  <div>
   <label>A vista?</label>
   <select id="avista">
     <option value="true">Sim</option>
     <option value="false">Não</option>
   </select>
  </div>

  <div>
   <label>Qtd parcelas</label>
   <input id="parcelas" type="number" value="1"/>
  </div>
 </div>

 <label>Dividido com alguém?</label>
 <select id="div">
   <option value="false">Não</option>
   <option value="true">Sim</option>
 </select>

 <label>Com quantas pessoas dividi?</label>
 <input id="qtdDiv" type="number" value="2"/>

 <label>Pessoa (se houver)</label>
 <select id="pessoa"></select>

 <label>Observação</label>
 <input id="obs"/>

 <button onclick="salvar()">Registrar</button>

 <hr/>

 <h3>Lista</h3>
 <div id="lista"></div>

</div>

<!-- TELA 2 – CARTEIRAS -->
<div class="painel" id="t2">

 <h3>Cadastrar carteira</h3>
 <label>Nome</label>
 <input id="nomeCart"/>

 <label>Limite PIX</label>
 <input id="limPix" type="number"/>

 <label>Limite Dinheiro</label>
 <input id="limDin" type="number"/>

 <label>Limite Cartão</label>
 <input id="limCard" type="number"/>

 <button onclick="salvarCart()">Cadastrar</button>

 <h3>Minhas contas fixas</h3>
 <ul>
  <li>Banco do Brasil – BB</li>
  <li>Caixa Econômica</li>
  <li>Bet365</li>
  <li>Carteira em dinheiro</li>
  <li>Nubank crédito</li>
  <li>Poupança</li>
  <li>Trabalho – Prefeituras</li>
 </ul>

</div>

<!-- TELA 3 – PESSOAS -->
<div class="painel" id="t3">

<h3>Cadastro de Pessoas</h3>

<label>Nome da pessoa</label>
<input id="nomePessoa"/>

<label>Tipo</label>
<select id="tipoPessoa">
 <option value="amigo">Amigo</option>
 <option value="familia">Família</option>
 <option value="trabalho">Trabalho</option>
</select>

<button onclick="salvarPessoa()">Salvar Pessoa</button>

<div id="listaPessoas"></div>

</div>

<!-- TELA 4 – DEVEDORES -->
<div class="painel" id="t4">

<h3>Quanto foi dividido por carteira</h3>

<label>Ano</label>
<input id="fAno" type="number" value="2025"/>

<label>Mês</label>
<input id="fMes" type="number" value="1"/>

<button onclick="carregarDev()">Consultar</button>

<h3>Total por carteira</h3>
<div id="totCart"></div>

<table id="tabDev">
<thead>
<tr>
 <th>Pessoa</th>
 <th>Mês</th>
 <th>Ano</th>
 <th>Total Devido</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

</div>

<script>
// KEYS
const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

const sb = supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// controle abas
function trocar(id){
 document.querySelectorAll('.aba').forEach(a=>a.classList.remove('ativa'));
 document.querySelectorAll('.painel').forEach(p=>p.classList.remove('show'));

 if(id==='t1')a1.classList.add('ativa');
 if(id==='t2')a2.classList.add('ativa');
 if(id==='t3')a3.classList.add('ativa');
 if(id==='t4')a4.classList.add('ativa');

 document.getElementById(id).classList.add('show');
}

// carregar combos
async function carregarCombos(){
 let c = await sb.from('carteiras').select('*');
 carteira.innerHTML = c.data.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');

 let p = await sb.from('pessoas').select('*');
 pessoa.innerHTML = p.data.map(x=>`<option value="${x.id}">${x.nome}</option>`).join('');
}

carregarCombos();

// salvar movimentação
async function salvar(){

 const mov = {
  data: new Date().toISOString(),
  onde: onde.value,
  descricao: descricao.value,
  valor: valor.value,
  carteira_id: carteira.value,
  modo_pagamento: modo.value,
  a_vista: avista.value==="true",
  parcelado: parcelas.value>1,
  parcelas: parcelas.value,
  dividido: div.value==="true",
  outra_pessoa_id: div.value==="true"? pessoa.value:null,
  observacao: obs.value
 };

 await sb.from('movimentacoes').insert(mov);
 carregarLista();
}

// lista mov
async function carregarLista(){
 let r = await sb.from('movimentacoes')
   .select('*')
   .order('data',{descending:true});

 lista.innerHTML = r.data.map(x=>
  `<div class="card">
    ${x.onde} – R$ ${x.valor}
  </div>`).join('');
}

carregarLista();


// salvar pessoa CORRIGIDO
async function salvarPessoa(){

 const p = {
  nome: nomePessoa.value,
  tipo: tipoPessoa.value,
  created_at: new Date().toISOString()
 };

 await sb.from('pessoas').insert(p);
 carregarPessoas();
}


// carregar pessoas
async function carregarPessoas(){
 let r = await sb.from('pessoas').select('*');
 listaPessoas.innerHTML = r.data.map(x=>
   `<div class="card">${x.nome} (${x.tipo})</div>`
 ).join('');
}

carregarPessoas();


// SALVAR CARTEIRA
async function salvarCart(){

 const cart = {
  nome: nomeCart.value,
  limite_pix: limPix.value,
  limite_dinheiro: limDin.value,
  limite_cartao: limCard.value,
  outra_pessoa:false,
  saldo_atual:0,
  created_at:new Date().toISOString()
 };

 await sb.from('carteiras').insert(cart);
}


// CALCULO DEVEDORES
async function carregarDev(){

 let ano = Number(fAno.value);
 let mes = Number(fMes.value);

 let r = await sb.rpc('calc_dev',{ano,mes});

}


// total por carteira dividido
async function carregarTotCarteira(){

 const {data} = await sb
 .from('movimentacoes')
 .select('valor,carteira_id,dividido');

 const g = {};

 data.forEach(m=>{
  if(!m.dividido)return;

  if(!g[m.carteira_id])g[m.carteira_id]=0;
