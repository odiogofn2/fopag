<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro v2.4</title>
<style>
body { font-family: Arial; background:#f5f5f5; padding:20px }
section { background:#fff; padding:15px; margin-bottom:20px; border-radius:6px }
input, select, button { margin:5px 0; padding:6px; width:100% }
.hidden { display:none }
table { width:100%; border-collapse:collapse }
th, td { border:1px solid #ddd; padding:6px }
th { background:#eee }
</style>
</head>

<body>

<h2>Financeiro Pessoal v2.4</h2>

<!-- AUTH -->
<section id="auth">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Senha">
  <button onclick="login()">Login</button>
  <button onclick="registerUser()">Registrar</button>
</section>

<!-- APP -->
<div id="app" class="hidden">

<!-- DASHBOARD -->
<section>
  <h3>Dashboard</h3>
  <p><b>Saldo real:</b> R$ <span id="saldo">0.00</span></p>
  <p><b>Total que me devem:</b> R$ <span id="meDevem">0.00</span></p>
</section>

<!-- CARTEIRAS -->
<section>
  <h3>Carteiras / Cartões</h3>
  <input id="wallet_name" placeholder="Nome da carteira/cartão">
  <select id="wallet_type">
    <option value="wallet">Carteira / Conta</option>
    <option value="credit_card">Cartão</option>
  </select>
  <input id="wallet_limit" type="number" placeholder="Limite (opcional)">
  <button onclick="addWallet()">Salvar</button>
  <ul id="wallets"></ul>
</section>

<!-- PESSOAS -->
<section>
  <h3>Pessoas</h3>
  <input id="person_name" placeholder="Nome">
  <button onclick="addPerson()">Adicionar</button>
  <ul id="people"></ul>
</section>

<!-- MOVIMENTAÇÃO -->
<section>
  <h3>Nova Movimentação</h3>

  <input id="desc" placeholder="Descrição">
  <input id="amount" type="number" placeholder="Valor">

  <select id="type">
    <option value="expense">Despesa</option>
    <option value="income">Receita</option>
  </select>

  <select id="wallet"></select>

  <select id="owner_type" onchange="ownerChange()">
    <option value="me">Minha</option>
    <option value="other">Outra pessoa</option>
    <option value="shared">Dividida</option>
  </select>

  <select id="person" class="hidden"></select>
  <input id="split" type="number" class="hidden" placeholder="Qtd pessoas">

  <label id="paidLabel" class="hidden">
    <input type="checkbox" id="paid" onchange="paidChange()"> Já me pagou
  </label>

  <input id="paid_value" type="number" class="hidden" placeholder="Valor pago">

  <button onclick="saveTransaction()">Salvar</button>
</section>

<!-- TRANSAÇÕES -->
<section>
  <h3>Movimentações</h3>
  <table>
    <thead>
      <tr>
        <th>Descrição</th>
        <th>Valor</th>
        <th>Minha Parte</th>
      </tr>
    </thead>
    <tbody id="transactions"></tbody>
  </table>
</section>

</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ========= SUPABASE (UMA ÚNICA VEZ) ========= */
window.supabaseClient = window.supabase.createClient(
  "https://rbxadmxxbrhgvbgcclxa.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJieGFkbXh4YnJoZ3ZiZ2NjbHhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTQ2MjAsImV4cCI6MjA4MzE5MDYyMH0.AI0_5k8t26J_Vu2WEBMB7lI8mzJDisV5bvKTAv42SjE"
);
</script>

<script>
/* ========= AUTH ========= */
async function login() {
  const { error } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) {
    alert(error.message);
  } else {
    startApp();
  }
}

async function registerUser() {
  const { error } = await supabaseClient.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (error) alert(error.message);
  else alert("Usuário criado com sucesso");
}

function startApp() {
  auth.classList.add("hidden");
  app.classList.remove("hidden");
  loadAll();
}

/* ========= UI ========= */
function ownerChange() {
  person.classList.toggle("hidden", owner_type.value === "me");
  split.classList.toggle("hidden", owner_type.value !== "shared");
  paidLabel.classList.toggle("hidden", owner_type.value !== "other");
  paid_value.classList.add("hidden");
  paid.checked = false;
}

function paidChange() {
  paid_value.classList.toggle("hidden", !paid.checked);
}

/* ========= LOAD ========= */
async function loadAll() {
  await loadWallets();
  await loadPeople();
  await loadTransactions();
}

async function loadWallets() {
  const { data } = await supabaseClient.from("wallets").select("*");
  wallet.innerHTML = "";
  wallets.innerHTML = "";
  data.forEach(w => {
    wallet.innerHTML += `<option value="${w.id}">${w.name}</option>`;
    wallets.innerHTML += `<li>${w.name}</li>`;
  });
}

async function loadPeople() {
  const { data } = await supabaseClient.from("people").select("*");
  person.innerHTML = "";
  people.innerHTML = "";
  data.forEach(p => {
    person.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    people.innerHTML += `<li>${p.name}</li>`;
  });
}

/* ========= CRUD ========= */
async function addWallet() {
  await supabaseClient.from("wallets").insert({
    name: wallet_name.value,
    type: wallet_type.value,
    limit: wallet_limit.value || null
  });
  wallet_name.value = "";
  wallet_limit.value = "";
  loadWallets();
}

async function addPerson() {
  await supabaseClient.from("people").insert({ name: person_name.value });
  person_name.value = "";
  loadPeople();
}

async function saveTransaction() {
  await supabaseClient.from("transactions").insert({
    description: desc.value,
    amount: amount.value,
    type: type.value,
    wallet_id: wallet.value,
    owner_type: owner_type.value,
    person_id: owner_type.value !== "me" ? person.value : null,
    split_count: owner_type.value === "shared" ? split.value : null,
    paid_by_other: paid.checked,
    other_paid_amount: paid_value.value || 0
  });

  desc.value = amount.value = "";
  loadTransactions();
}

/* ========= DASHBOARD ========= */
async function loadTransactions() {
  const { data } = await supabaseClient.from("transactions").select("*");
  transactions.innerHTML = "";

  let saldo = 0;
  let meDevem = 0;

  data.forEach(t => {
    let minhaParte = t.amount;

    if (t.owner_type === "shared" && t.split_count) {
      minhaParte = t.amount / t.split_count;
    }

    if (t.owner_type === "other") {
      minhaParte = t.paid_by_other ? 0 : (t.amount - t.other_paid_amount);
      meDevem += minhaParte;
    }

    saldo += t.type === "income" ? minhaParte : -minhaParte;

    transactions.innerHTML += `
      <tr>
        <td>${t.description}</td>
        <td>R$ ${Number(t.amount).toFixed(2)}</td>
        <td>R$ ${Number(minhaParte).toFixed(2)}</td>
      </tr>`;
  });

  saldoEl.innerText = saldo.toFixed(2);
  meDevemEl.innerText = meDevem.toFixed(2);
}

/* ========= AUTO LOGIN ========= */
const saldoEl = document.getElementById("saldo");
const meDevemEl = document.getElementById("meDevem");

supabaseClient.auth.getSession().then(({ data }) => {
  if (data.session) startApp();
});
</script>

</body>
</html>
