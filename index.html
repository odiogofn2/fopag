<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle Financeiro</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; background:#f5f5f5; }
    .container { width:90%; max-width:1100px; margin:20px auto; }

    .card {
      background:white;
      padding:12px;
      margin:10px 0;
      border-radius:8px;
      box-shadow:0 0 5px #ccc;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
    }

    th,td {
      border:1px solid #ddd;
      padding:6px;
      text-align:left;
    }

    input, select, button {
      padding:6px;
      margin:4px 0;
      width:100%;
      box-sizing:border-box;
    }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

    .filtros {
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:6px;
    }

    .totais {
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:6px;
      font-weight:bold;
    }
  </style>
</head>

<body>

<div class="container">

<h2>üí∞ Meu Controle Financeiro</h2>

<!-- CADASTRO DE CARTEIRAS -->
<div class="card">
<h3>Carteiras</h3>

<div id="listaCarteiras"></div>

<h4>Nova carteira</h4>

<input id="nomeCarteira" placeholder="Nome da carteira">
<div class="row">
  <input id="saldoCarteira" placeholder="Saldo inicial" type="number">

  <select id="tipoCarteira">
    <option value="conta">Conta</option>
    <option value="cartao">Cart√£o</option>
    <option value="dinheiro">Dinheiro</option>
    <option value="investimento">Investimento</option>
  </select>
</div>

<div class="filtros">
  <input id="limitePix" placeholder="Limite PIX" type="number">
  <input id="limiteDinheiro" placeholder="Limite Dinheiro" type="number">
  <input id="limiteCartao" placeholder="Limite Cart√£o" type="number">
</div>

<button onclick="criarCarteira()">Cadastrar carteira</button>
</div>


<!-- PESSOAS -->
<div class="card">
<h3>Pessoas</h3>

<div id="listaPessoas"></div>

<input id="nomePessoa" placeholder="Nome da pessoa">
<select id="tipoPessoa">
  <option value="pessoal">Pessoal</option>
  <option value="amigo">Amigo</option>
  <option value="familia">Fam√≠lia</option>
  <option value="cliente">Cliente</option>
</select>

<button onclick="criarPessoa()">Cadastrar pessoa</button>
</div>


<!-- MOVIMENTA√á√ÉO -->
<div class="card">
<h3>Incluir Movimenta√ß√£o</h3>

<input id="dataMov" type="datetime-local">

<input id="ondeMov" placeholder="Onde foi">

<input id="descMov" placeholder="O que foi">

<input id="valorMov" placeholder="Valor" type="number">

<select id="carteiraMov"></select>

<select id="modoPag">
  <option value="pix">PIX</option>
  <option value="cartao">Cart√£o</option>
  <option value="dinheiro">Dinheiro</option>
  <option value="transferencia">Transfer√™ncia</option>
</select>

<div class="row">
  <select id="forma">
    <option value="avista">√Ä vista</option>
    <option value="parcelado">Parcelado</option>
  </select>

  <input id="qtdParcelas" placeholder="N¬∫ parcelas" type="number">
</div>

<select id="outraPessoa">
  <option value="">Despesa s√≥ minha</option>
</select>

<div class="row">
  <select id="dividiu">
    <option value="nao">N√£o dividi</option>
    <option value="sim">Dividi com algu√©m</option>
  </select>

  <select id="pessoaRateio"></select>
</div>

<input id="obsMov" placeholder="Observa√ß√£o">

<button onclick="incluirMov()">Registrar</button>
</div>


<!-- RELAT√ìRIOS -->
<div class="card">

<h3>Relat√≥rio do Per√≠odo</h3>

<div class="filtros">
  <input id="mesFiltro" placeholder="M√™s" type="number">
  <input id="anoFiltro" placeholder="Ano" type="number">
  <select id="carteiraFiltro"></select>
</div>

<button onclick="carregarMov()">Filtrar</button>

<div class="totais" id="totais"></div>

<table>
<thead>
<tr>
  <th>Data</th>
  <th>Onde</th>
  <th>Descri√ß√£o</th>
  <th>Valor</th>
  <th>Pagamento</th>
  <th>Carteira</th>
  <th>Rateio</th>
</tr>
</thead>

<tbody id="tabelaMov"></tbody>
</table>

</div>

</div>

<!-- SCRIPT PRINCIPAL -->
<script>

const SUPABASE_URL = "https://kkecunfjxflmetsqczrt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZWN1bmZqeGZsbWV0c3FjenJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NzMzNTEsImV4cCI6MjA4MzI0OTM1MX0.bzOf9CfUlMRYItyOV_e7w42vsbudaAQSF7cZUCUTE_A";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


// ---- CARTEIRAS INICIAIS DO SEU PERFIL ----
async function seedCarteiras() {

 const iniciais = [
  { nome:"Conta Banco do Brasil", saldo:0 },
  { nome:"Conta Caixa", saldo:0 },
  { nome:"Bet365", saldo:0 },
  { nome:"Carteira em dinheiro", saldo:0 },
  { nome:"Cart√£o de cr√©dito Nubank", saldo:0 },
  { nome:"Poupan√ßa", saldo:0 },
  { nome:"Trabalho ‚Äì recebimentos de prefeituras", saldo:0 }
 ];

 for (const c of iniciais) {
   await db.from("carteiras").insert(c);
 }
}


// ---------------- PESSOAS ----------------

async function criarPessoa() {

 const nome = document.getElementById("nomePessoa").value;
 const tipo = document.getElementById("tipoPessoa").value;

 await db.from("pessoas").insert({ nome, tipo });

 document.getElementById("nomePessoa").value="";

 carregarPessoas();
}


// ---------------- CARTEIRAS --------------

async function criarCarteira() {

 const nome = nomeCarteira.value;
 const saldo = parseFloat(saldoCarteira.value || 0);

 await db.from("carteiras").insert({
   nome,
   saldo,
   limite_pix: parseFloat(limitePix.value||0),
   limite_dinheiro: parseFloat(limiteDinheiro.value||0),
   limite_cartao: parseFloat(limiteCartao.value||0)
 });

 carregarCarteiras();
}


// ---------------- MOVIMENTA√á√ïES -----------

async function incluirMov() {

 const data = dataMov.value;
 const onde = ondeMov.value;
 const descricao = descMov.value;
 const valor = parseFloat(valorMov.value||0);
 const carteira_id = carteiraMov.value;
 const modo_pagamento = modoPag.value;

 const parcelado = forma.value==="parcelado";
 const parcelas = parseFloat(qtdParcelas.value||1);

 const dividido = dividiu.value==="sim";
 const pessoa_id = pessoaRateio.value;

 const outra_pessoa_id = outraPessoa.value || null;

 // atualiza saldo se √† vista
 if (!parcelado) {
   const { data:c } = await db
     .from("carteiras")
     .select("*")
     .eq("id", carteira_id)
     .single();

   await db.from("carteiras")
     .update({ saldo: c.saldo - valor })
     .eq("id", carteira_id);
 }

 const { data:mov } = await db.from("movimentacoes")
  .insert({
    data,
    onde,
    descricao,
    valor,
    carteira_id,
    modo_pagamento,
    a_vista: !parcelado,
    parcelado,
    parcelas,
    outra_pessoa_id,
    dividido,
    observacao: obsMov.value
  })
  .select()
  .single();


 if (dividido && pessoa_id) {

   const parte = valor/2;

   await db.from("rateios").insert([
     { movimentacao_id: mov.id, pessoa_id: null, valor_parte: parte },
     { movimentacao_id: mov.id, pessoa_id, valor_parte: parte }
   ]);
 }

 valorMov.value="";
 descMov.value="";
 ondeMov.value="";

 carregarCarteiras();
 carregarMov();
}


// ----------------- CONSULTAS --------------

async function carregarCarteiras() {

 const { data } = await db.from("carteiras").select("*");

 listaCarteiras.innerHTML =
  data.map(c =>
   `<div class='card'>
     ${c.nome}<br>
     Saldo: R$ ${c.saldo.toFixed(2)}
    </div>`
  ).join("");


 // preenche selects
 const opts =
   data.map(c =>
     `<option value="${c.id}">${c.nome}</option>`
   ).join("");

 carteiraMov.innerHTML = opts;
 carteiraFiltro.innerHTML = "<option value=''>Todas</option>"+opts;
 carteiraMov.innerHTML = opts;

 carteiraMov.innerHTML = opts;
 carteiraFiltro.innerHTML = opts;

 carteiraMov.innerHTML = opts;

 carteiraFiltro.innerHTML = opts;

 carteiraMov.innerHTML = opts;

 carteiraMov.innerHTML = opts;


 carteiraFiltro.innerHTML = opts;


 carteiraMov.innerHTML = opts;

 carteiraMov.innerHTML = opts;

 carteiraMov.innerHTML = opts;

 carteiraFiltro.innerHTML = opts;


 carteiraMov.innerHTML = opts;

 carteiraFiltro.innerHTML = opts;


 carteiraMov.innerHTML = opts;


 carteiraMov.innerHTML = opts;


 carteiraFiltro.innerHTML = opts;


 carteiraMov.innerHTML = opts;


 carteiraFiltro.innerHTML = opts;


 carteiraMov.innerHTML = opts;


 carteiraFiltro.innerHTML = opts;


 carteiraMov.innerHTML = opts;


 carteiraFiltro.innerHTML = opts;


 // simples e direto:
 document.getElementById("carteiraMov").innerHTML = opts;
 document.getElementById("carteiraFiltro").innerHTML = opts;

 document.getElementById("carteiraMov").innerHTML = opts;
 document.getElementById("carteiraFiltro").innerHTML = opts;
}


async function carregarPessoas() {

 const { data } = await db.from("pessoas").select("*");

 listaPessoas.innerHTML =
  data.map(p =>
   `<div class='card'>${p.nome}</div>`
  ).join("");

 const opts =
   data.map(p =>
    `<option value="${p.id}">${p.nome}</option>`
   ).join("");

 pessoaRateio.innerHTML = opts;
 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.inner.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;

 pessoaRateio.innerHTML = opts;


 document.getElementById("outraPessoa").innerHTML =
   "<option value=''>Despesa s√≥ minha</option>"+opts;

 document.getElementById("pessoaRateio").innerHTML = opts;
}


async function carregarMov() {

 const mes = mesFiltro.value;
 const ano = anoFiltro.value;
 const carteira = carteiraFiltro.value;

 let query = db.from("movimentacoes").select("*, carteiras(nome), pessoas(nome)");

 if (mes) query = query.ilike("data", `${ano}-${mes.padStart(2,'0')}%`);
 if (carteira) query = query.eq("carteira_id", carteira);

 const { data } = await query.order("data",{ ascending:false });

 tabelaMov.innerHTML =
 data.map(m =>
  `<tr>
    <td>${new Date(m.data).toLocaleString()}</td>
    <td>${m.onde}</td>
    <td>${m.descricao}</td>
    <td>R$ ${m.valor.toFixed(2)}</td>
    <td>${m.modo_pagamento}</td>
    <td>${m.carteiras?.nome || ''}</td>
    <td>${m.dividido ? 'Sim' : 'N√£o'}</td>
   </tr>`
 ).join("");


 // totais do filtro
 const total = data.reduce((s,m)=>s+m.valor,0);

 totais.innerHTML =
  `<div>Total no per√≠odo: R$ ${total.toFixed(2)}</div>`;
}


// ------------- INIT -----------------------

carregarCarteiras();
carregarPessoas();
carregarMov();

</script>

</body>
</html>
