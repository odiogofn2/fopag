<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
<div class="card">

<h2>Dívida de Terceiros</h2>

<label>Descrição</label>
<input id="div-descricao" placeholder="Ex: Compra no cartão Amazon">


<label>Pessoa Responsável pela Dívida</label>
<select id="div-pessoa"></select>


<label>Carteira onde foi lançada</label>
<select id="div-carteira"></select>


<label>Valor</label>
<input id="div-valor" type="number">


<label>Ela já pagou?</label>
<select id="div-status">
  <option value="pendente">Não pagou (pendente)</option>
  <option value="pago">Pago pela pessoa</option>
  <option value="dividido">Dividido entre nós</option>
</select>


<label>Marcar como pago por ela</label>
<input id="div-pago-pessoa" type="checkbox">


<label>Parcelado?</label>
<select id="div-parcelado">
  <option value="1">À vista</option>
  <option value="2">2x</option>
  <option value="3">3x</option>
  <option value="4">4x</option>
  <option value="6">6x</option>
  <option value="12">12x</option>
</select>


<button onclick="salvarDivida()">
  Salvar Dívida
</button>


<hr>

<h3>Lançamentos</h3>
<div id="div-lista"></div>

</div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL =
 parent.SUPABASE_URL;

const SUPABASE_ANON_KEY =
 parent.SUPABASE_ANON_KEY;


const supa =
 supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
 );


async function iniciarCombos() {

 const user =
  (await supa.auth.getUser())
   .data.user;

 if (!user) return;


 const pessoas =
  await supa
   .from("pessoas")
   .select("*")
   .order("nome",
     {ascending:true});


 const carteiras =
  await supa
   .from("carteiras")
   .select("*")
   .order("nome",
     {ascending:true});



 const selP =
  document
   .getElementById(
    "div-pessoa"
   );

 const selC =
  document
   .getElementById(
    "div-carteira"
   );


 pessoas.data.forEach(p=>{
  selP.innerHTML +=
   `<option value="${p.id}">${p.nome}</option>`;
 });


 carteiras.data.forEach(c=>{
  selC.innerHTML +=
   `<option value="${c.id}">${c.nome}</option>`;
 });

}


async function salvarDivida() {

 const user =
  (await supa.auth.getUser())
   .data.user;

 if (!user) {
  alert("Faça login");
  return;
 }


 const descricao =
  document
   .getElementById("div-descricao")
   .value.trim();


 const pessoa_id =
  document
   .getElementById("div-pessoa")
   .value;

 const carteira_id =
  document
   .getElementById("div-carteira")
   .value;

 const valor =
  Number(
   document
    .getElementById("div-valor")
    .value
  );

 const status_pagamento =
  document
   .getElementById("div-status")
   .value;


 const pago_pela_pessoa =
  document
   .getElementById("div-pago-pessoa")
   .checked;


 const parcelas_total =
  Number(
   document
    .getElementById("div-parcelado")
    .value || 1
  );


 if (!descricao || !valor) {
  alert("Preencha descrição e valor");
  return;
 }


 /* CALCULO AUTOMATICO MES/ANO */
 const hoje = new Date();

 const mes = hoje.getMonth()+1;
 const ano = hoje.getFullYear();


 const { error } =
  await supa
   .from("dividas_terceiros")
   .insert({

     descricao,
     valor,

     pessoa_id,
     carteira_id,

     status_pagamento,

     pago_pela_pessoa:
       pago_pela_pessoa,

     parcelas_total,

     mes,
     ano,

     user_id: user.id

  });


 if (error) {
  alert(error.message);
  return;
 }

 alert("Dívida salva");
 carregar();
}



async function carregar() {

 const user =
  (await supa.auth.getUser())
   .data.user;

 if (!user) return;


 const {data,error} =
  await supa
   .from("dividas_terceiros")
   .select("*")
   .order("created_at",
    {ascending:false});


 if (error) {
  alert(error.message);
  return;
 }



 const lista =
  document
   .getElementById(
    "div-lista"
   );


 lista.innerHTML="";



 data.forEach(d => {

  lista.innerHTML += `
   <div class="item">
    <b>${d.descricao}</b>
    <br>Valor: ${d.valor}
    <br>Mês/Ano: ${d.mes}/${d.ano}
    <br>Status: ${d.status_pagamento}
    <br>Pago por ela? ${d.pago_pela_pessoa}
   </div><br>
  `;
 });

}


iniciarCombos();
carregar();
</script>


</body>
</html>
